#!/bin/bash -eu

# uninstall: Remove cssh configuration
#
# This script:
#   1. Removes ~/.profile.d/cssh
#   2. Optionally removes cached certificates
#   3. Optionally removes cssh-managed entries from SSH config
#
# The script files themselves are not removed - delete the cssh/ directory manually if desired.

HERE=$(cd "$(dirname "$0")" && pwd)
readonly HERE

# Colors (only if terminal supports them)
if [[ -t 1 ]]; then
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  NC='\033[0m'
else
  GREEN=''
  YELLOW=''
  NC=''
fi

info() {
  echo -e "${GREEN}==>${NC} $*"
}

warn() {
  echo -e "${YELLOW}warning:${NC} $*" >&2
}

# Prompt for yes/no
confirm() {
  local prompt_text="$1"
  local default="${2:-n}"

  local yn_hint
  if [[ "${default}" == "y" ]]; then
    yn_hint="[Y/n]"
  else
    yn_hint="[y/N]"
  fi

  local response
  read -r -p "${prompt_text} ${yn_hint}: " response
  response="${response:-${default}}"

  case "${response}" in
    [yY]|[yY][eE][sS]) return 0 ;;
    *) return 1 ;;
  esac
}

main() {
  echo "cssh uninstaller"
  echo "================"
  echo

  local profile_file="${HOME}/.profile.d/cssh"
  local cache_dir="${CSSH_CACHE_DIR:-${HOME}/.cache/cssh}"
  local ssh_config="${CSSH_SSH_CONFIG:-${HOME}/.ssh/config}"

  # Remove profile configuration
  if [[ -f "${profile_file}" ]]; then
    info "Found profile configuration: ${profile_file}"
    if confirm "Remove profile configuration?"; then
      rm -f "${profile_file}"
      echo "  Removed ${profile_file}"
    fi
  else
    echo "No profile configuration found at ${profile_file}"
  fi

  echo

  # Remove cached certificates
  if [[ -d "${cache_dir}" ]]; then
    local cert_count
    cert_count=$(find "${cache_dir}" -name "*-cert.pub" 2>/dev/null | wc -l | tr -d ' ')
    info "Found certificate cache: ${cache_dir} (${cert_count} certificate(s))"
    if confirm "Remove cached certificates?"; then
      rm -rf "${cache_dir}"
      echo "  Removed ${cache_dir}"
    fi
  else
    echo "No certificate cache found at ${cache_dir}"
  fi

  echo

  # Remove SSH config entries
  if [[ -f "${ssh_config}" ]]; then
    local patterns
    patterns=$(grep "^# cssh-managed:" "${ssh_config}" 2>/dev/null | sed 's/^# cssh-managed: //' || true)

    if [[ -n "${patterns}" ]]; then
      info "Found cssh-managed entries in ${ssh_config}:"
      echo "${patterns}" | while read -r p; do
        echo "    ${p}"
      done

      if confirm "Remove all cssh-managed SSH config entries?"; then
        # Remove each pattern
        echo "${patterns}" | while read -r pattern; do
          if [[ -n "${pattern}" ]]; then
            "${HERE}/config" remove --pattern "${pattern}" --ssh-config "${ssh_config}" 2>/dev/null || true
          fi
        done
        echo "  Removed cssh-managed entries from ${ssh_config}"
      fi
    else
      echo "No cssh-managed entries found in ${ssh_config}"
    fi
  else
    echo "No SSH config found at ${ssh_config}"
  fi

  echo
  echo -e "${GREEN}Uninstall complete.${NC}"
  echo
  echo "Note: The cssh scripts at ${HERE} were not removed."
  echo "To remove them, run: rm -rf ${HERE}"
  echo
  echo "To apply changes in this shell, either:"
  echo "  - Start a new shell, or"
  echo "  - Unset the cssh environment variables manually"
}

main "$@"
