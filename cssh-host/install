#!/bin/bash -eu

# install: Configure this host to accept Vault-signed SSH user certificates
#
# Usage: ./install
#
# This script will:
#   1. Prompt for Vault configuration (or use existing environment variables)
#   2. Detect the platform (macOS, Linux, Unraid, TrueNAS)
#   3. Delegate to the appropriate platform-specific installer
#
# Supported platforms:
#   - macOS
#   - Linux with systemd
#   - Unraid (Slackware)
#   - TrueNAS SCALE (Debian Bookworm, 25.04+)

HERE=$(cd "$(dirname "$0")" && pwd)
readonly HERE

# Colors (only if terminal supports them)
if [[ -t 1 ]]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  NC='\033[0m'
else
  RED=''
  GREEN=''
  YELLOW=''
  NC=''
fi

info() {
  echo -e "${GREEN}==>${NC} $*"
}

warn() {
  echo -e "${YELLOW}warning:${NC} $*" >&2
}

fail() {
  echo -e "${RED}error:${NC} $*" >&2
  exit 1
}

# Check for a required command
check_dependency() {
  local cmd="$1"
  local install_hint="$2"

  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo -e "${RED}error:${NC} '$cmd' is required but not installed." >&2
    echo "  ${install_hint}" >&2
    return 1
  fi
  return 0
}

# Prompt for input with optional default value
prompt() {
  local var_name="$1"
  local prompt_text="$2"
  local default_value="${3:-}"

  # Check if already set in environment
  local current_value
  eval "current_value=\${${var_name}:-}"

  if [[ -n "${current_value}" ]]; then
    echo "${prompt_text}: ${current_value} (from environment)"
    return
  fi

  local input
  if [[ -n "${default_value}" ]]; then
    read -r -p "${prompt_text} [${default_value}]: " input
    input="${input:-${default_value}}"
  else
    read -r -p "${prompt_text}: " input
  fi

  eval "export ${var_name}=\"\${input}\""
}

# Detect platform
detect_platform() {
  if [[ -f /etc/unraid-version ]]; then
    echo "unraid"
  elif command -v midclt >/dev/null 2>&1 && [[ -f /etc/version ]]; then
    echo "truenas"
  elif [[ "$(uname)" == "Darwin" ]]; then
    echo "macos"
  elif command -v systemctl >/dev/null 2>&1; then
    echo "linux"
  else
    echo "unknown"
  fi
}

main() {
  echo "cssh-host installer"
  echo "==================="
  echo
  echo "This will configure this host to accept Vault-signed SSH user certificates."
  echo

  # Check dependencies
  info "Checking dependencies..."
  local deps_ok=1

  check_dependency curl "Install via your package manager" || deps_ok=0

  if [[ ${deps_ok} -eq 0 ]]; then
    echo
    fail "Please install missing dependencies and run this script again."
  fi

  echo "  All dependencies found."
  echo

  # Detect platform
  info "Detecting platform..."
  local platform
  platform=$(detect_platform)

  case "${platform}" in
    unraid)
      echo "  Detected: Unraid (Slackware)"
      ;;
    truenas)
      echo "  Detected: TrueNAS SCALE"
      # TrueNAS needs jq for midclt output parsing
      if ! command -v jq >/dev/null 2>&1; then
        fail "jq is required for TrueNAS but not installed"
      fi
      ;;
    macos)
      echo "  Detected: macOS"
      ;;
    linux)
      echo "  Detected: Linux (systemd)"
      ;;
    *)
      fail "Unsupported platform. Supported: macOS, Linux (systemd), Unraid, TrueNAS SCALE"
      ;;
  esac

  echo

  # Gather configuration
  info "Configuration"
  echo
  echo "Enter your Vault server details. Values from environment variables will be used if set."
  echo

  prompt VAULT_BASE_URL "Vault server URL (e.g., https://vault.example.com)"
  if [[ -z "${VAULT_BASE_URL:-}" ]]; then
    fail "Vault URL is required"
  fi

  prompt VAULT_SSH_USER_MOUNT_PATH "Vault SSH user mount path (e.g., ssh-client-signer)"
  if [[ -z "${VAULT_SSH_USER_MOUNT_PATH:-}" ]]; then
    fail "Vault mount path is required"
  fi

  echo

  # Summary
  info "Configuration summary"
  echo "  Platform:         ${platform}"
  echo "  Vault URL:        ${VAULT_BASE_URL}"
  echo "  Vault mount path: ${VAULT_SSH_USER_MOUNT_PATH}"
  echo "  CA key endpoint:  ${VAULT_BASE_URL}/v1/${VAULT_SSH_USER_MOUNT_PATH}/public_key"
  echo

  # Save configuration for update-ca-key script
  info "Saving configuration to /etc/cssh-host.conf..."
  sudo tee /etc/cssh-host.conf > /dev/null <<EOF
# cssh-host configuration
# Generated by cssh-host/install

VAULT_BASE_URL="${VAULT_BASE_URL}"
VAULT_SSH_USER_MOUNT_PATH="${VAULT_SSH_USER_MOUNT_PATH}"
EOF
  sudo chmod 0644 /etc/cssh-host.conf
  echo "  Saved."
  echo

  # Delegate to platform-specific installer
  info "Running platform-specific installer..."
  echo

  case "${platform}" in
    unraid)
      exec "${HERE}/install-unraid"
      ;;
    truenas)
      exec "${HERE}/install-truenas"
      ;;
    macos)
      exec "${HERE}/install-generic" --platform macos
      ;;
    linux)
      exec "${HERE}/install-generic" --platform linux
      ;;
  esac
}

main "$@"
